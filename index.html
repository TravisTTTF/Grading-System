<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Engineering Report Grading System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const EssayGradingSystem = () => {
            const [phase, setPhase] = useState('setup');
            const [essayFile, setEssayFile] = useState(null);
            const [rubricFile, setRubricFile] = useState(null);
            const [totalScore, setTotalScore] = useState(100);
            const [gradingResults, setGradingResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState(0);
            const [currentProgressMessage, setCurrentProgressMessage] = useState('');
            const [agentResults, setAgentResults] = useState({});
            const [apiError, setApiError] = useState('');

            // Engineering-specific metrics with specialized agent assignments
            const [metrics, setMetrics] = useState([
                { 
                    name: 'Technical Analysis & Methodology', 
                    weight: 30, 
                    description: 'Engineering calculations, experimental design, data analysis methods, technical accuracy, appropriate use of engineering tools and software', 
                    isDefault: true,
                    primaryAgent: 1, // Content Expert
                    supportingAgents: [3] // Structure Expert
                },
                { 
                    name: 'Problem Definition & Solution Design', 
                    weight: 25, 
                    description: 'Problem statement clarity, constraints identification, design alternatives, feasibility analysis, optimization considerations', 
                    isDefault: true,
                    primaryAgent: 1, // Content Expert
                    supportingAgents: [4] // Innovation Expert
                },
                { 
                    name: 'Professional Documentation', 
                    weight: 20, 
                    description: 'Technical writing standards, proper engineering notation, figure/table formatting, citation of technical standards, appendices organization', 
                    isDefault: true,
                    primaryAgent: 2, // Language Expert
                    supportingAgents: [3] // Structure Expert
                },
                { 
                    name: 'Results & Discussion', 
                    weight: 15, 
                    description: 'Data presentation, uncertainty analysis, comparison with theoretical values, limitations discussion, future recommendations', 
                    isDefault: true,
                    primaryAgent: 1, // Content Expert
                    supportingAgents: [4] // Innovation Expert
                },
                { 
                    name: 'Safety & Ethics Considerations', 
                    weight: 10, 
                    description: 'Risk assessment, safety protocols, environmental impact, ethical implications, compliance with engineering standards', 
                    isDefault: true,
                    primaryAgent: 4, // Innovation Expert (for holistic thinking)
                    supportingAgents: [1] // Content Expert
                }
            ]);

            // Specialized agents for engineering evaluation
            const [agents, setAgents] = useState([
                { 
                    id: 1, 
                    name: 'Technical Content Expert', 
                    emoji: '‚öôÔ∏è', 
                    expertise: `You are an engineering professor specializing in technical analysis. Evaluate:
                    - Correctness of engineering calculations and formulas
                    - Appropriate selection and application of engineering principles
                    - Quality of experimental methodology and data collection
                    - Accuracy of technical diagrams, schematics, and CAD drawings
                    - Proper use of engineering software and simulation tools
                    - Validity of assumptions and boundary conditions
                    - Unit consistency and significant figures handling` 
                },
                { 
                    id: 2, 
                    name: 'Technical Writing Expert', 
                    emoji: 'üìê', 
                    expertise: `You are a technical communication specialist for engineering. Evaluate:
                    - Adherence to engineering report format standards (IEEE, ASME, etc.)
                    - Proper use of technical terminology and nomenclature
                    - Clarity of technical descriptions and procedures
                    - Quality of figure captions and table titles
                    - Appropriate use of passive voice in methodology sections
                    - Consistency in notation and abbreviations
                    - Professional tone and objective language` 
                },
                { 
                    id: 3, 
                    name: 'Report Structure Expert', 
                    emoji: 'üèóÔ∏è', 
                    expertise: `You are an expert in engineering documentation structure. Evaluate:
                    - Logical flow from problem statement to conclusions
                    - Proper section hierarchy and numbering (1.0, 1.1, 1.1.1)
                    - Executive summary completeness and accuracy
                    - Appropriate appendix usage for detailed calculations
                    - Cross-referencing between text, figures, and tables
                    - Balance between main content and supporting material
                    - Compliance with specified report format requirements` 
                },
                { 
                    id: 4, 
                    name: 'Engineering Innovation Expert', 
                    emoji: 'üí°', 
                    expertise: `You are an engineering innovation and design thinking expert. Evaluate:
                    - Creativity in problem-solving approach
                    - Consideration of multiple design alternatives
                    - Integration of sustainability and lifecycle thinking
                    - Application of emerging technologies or methods
                    - Critical evaluation of results and limitations
                    - Practical feasibility and implementation considerations
                    - Forward-thinking recommendations and future work` 
                }
            ]);

            const [supervisorSettings, setSupervisorSettings] = useState({
                strictness: 'balanced',
                focusAreas: ['technical_accuracy', 'professional_standards', 'innovation'],
                gradeDistribution: 'normal', // normal, lenient, strict
                industryStandards: true
            });

            // Add mock mode toggle
            const [mockMode, setMockMode] = useState(false);

            // API settings with model selection
            const [apiSettings, setApiSettings] = useState({
                useNetlifyFunctions: true,
                provider: 'openai',
                model: 'gpt-4o-mini',
                temperature: 0.3 // Lower temperature for more consistent grading
            });

            // Save and load configuration
            const saveConfiguration = () => {
                const config = {
                    metrics,
                    totalScore,
                    agents,
                    supervisorSettings,
                    apiSettings
                };
                localStorage.setItem('engineeringGradingConfig', JSON.stringify(config));
                alert('Configuration saved successfully!');
            };

            const loadConfiguration = () => {
                try {
                    const saved = localStorage.getItem('engineeringGradingConfig');
                    if (saved) {
                        const config = JSON.parse(saved);
                        if (config.metrics) setMetrics(config.metrics);
                        if (config.totalScore) setTotalScore(config.totalScore);
                        if (config.agents) setAgents(config.agents);
                        if (config.apiSettings) setApiSettings(config.apiSettings);
                        if (config.supervisorSettings) setSupervisorSettings(config.supervisorSettings);
                    }
                } catch (error) {
                    console.error('Error loading configuration:', error);
                }
            };

            useEffect(() => {
                loadConfiguration();
            }, []);

            const saveResults = () => {
                const results = {
                    date: new Date().toISOString(),
                    reportType: 'Engineering Report',
                    totalScore,
                    finalScore: Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0) * (totalScore / 100)),
                    percentage: Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0)),
                    details: gradingResults,
                    agentAnalysis: agentResults
                };
                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `engineering_report_grading_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files[0];
                if (file) {
                    if (type === 'essay') {
                        setEssayFile(file);
                    } else {
                        setRubricFile(file);
                    }
                }
            };

            const startGrading = () => {
                if (!essayFile) {
                    alert('Please upload an engineering report file');
                    return;
                }
                
                const totalWeight = metrics.reduce((sum, m) => sum + m.weight, 0);
                if (totalWeight !== 100) {
                    alert('Metric weights must sum to 100%');
                    return;
                }
                
                setPhase('grading');
                setApiError('');
                performSpecializedGrading();
            };

            const performSpecializedGrading = async () => {
                setLoading(true);
                setProgress(0);
                setAgentResults({});
                
                try {
                    setCurrentProgressMessage('Reading engineering report...');
                    const reportText = await readFileAsText(essayFile);
                    const rubricText = rubricFile ? await readFileAsText(rubricFile) : '';
                    
                    setCurrentProgressMessage('Initializing specialized AI agents...');
                    setProgress(10);
                    
                    const results = [];
                    const agentResultsData = {};
                    
                    // Step 1: Specialized evaluation - each metric evaluated by its assigned agents
                    let currentProgress = 10;
                    const progressPerMetric = 70 / metrics.length;
                    
                    for (const metric of metrics) {
                        setCurrentProgressMessage(`Evaluating: ${metric.name}...`);
                        
                        // Primary agent evaluation
                        const primaryAgent = agents.find(a => a.id === metric.primaryAgent);
                        if (primaryAgent) {
                            const primaryResult = await evaluateMetricWithAgent(
                                primaryAgent, 
                                metric, 
                                reportText, 
                                rubricText
                            );
                            
                            if (!agentResultsData[primaryAgent.id]) {
                                agentResultsData[primaryAgent.id] = {};
                            }
                            agentResultsData[primaryAgent.id][metric.name] = primaryResult;
                        }
                        
                        // Supporting agents evaluation (if any)
                        if (metric.supportingAgents && metric.supportingAgents.length > 0) {
                            for (const supportingAgentId of metric.supportingAgents) {
                                const supportingAgent = agents.find(a => a.id === supportingAgentId);
                                if (supportingAgent) {
                                    const supportingResult = await evaluateMetricWithAgent(
                                        supportingAgent, 
                                        metric, 
                                        reportText, 
                                        rubricText
                                    );
                                    
                                    if (!agentResultsData[supportingAgent.id]) {
                                        agentResultsData[supportingAgent.id] = {};
                                    }
                                    agentResultsData[supportingAgent.id][metric.name] = supportingResult;
                                }
                            }
                        }
                        
                        currentProgress += progressPerMetric;
                        setProgress(currentProgress);
                    }
                    
                    setAgentResults(agentResultsData);
                    
                    // Step 2: Consensus building for each metric
                    setCurrentProgressMessage('Building consensus from expert evaluations...');
                    setProgress(85);
                    
                    for (const metric of metrics) {
                        const metricEvaluations = [];
                        
                        // Collect all evaluations for this metric
                        Object.entries(agentResultsData).forEach(([agentId, agentData]) => {
                            if (agentData[metric.name]) {
                                const agent = agents.find(a => a.id === parseInt(agentId));
                                metricEvaluations.push({
                                    agent: agent,
                                    evaluation: agentData[metric.name],
                                    isPrimary: metric.primaryAgent === parseInt(agentId)
                                });
                            }
                        });
                        
                        // Get consensus from API
                        const consensusResult = await getConsensusFromAPI(metricEvaluations, metric, rubricText);
                        
                        results.push({
                            ...metric,
                            score: consensusResult.consensusScore,
                            agentScores: metricEvaluations.map(e => ({
                                agent: e.agent.name,
                                score: e.evaluation.score,
                                feedback: e.evaluation.feedback,
                                confidence: e.evaluation.confidence,
                                isPrimary: e.isPrimary
                            })),
                            consensus: consensusResult.consensusScore,
                            consensusReasoning: consensusResult.reasoning,
                            feedback: consensusResult.synthesizedFeedback,
                            dialogue: generateSpecializedDialogue(metricEvaluations, metric, consensusResult),
                            agreements: consensusResult.agreements,
                            disagreements: consensusResult.disagreements,
                            flagsForReview: consensusResult.flagsForReview
                        });
                    }
                    
                    setGradingResults(results);
                    setProgress(100);
                    setCurrentProgressMessage('Grading completed!');
                    setLoading(false);
                    setPhase('supervision');
                    
                } catch (error) {
                    console.error('Error in specialized grading:', error);
                    setApiError(`API Error: ${error.message}`);
                    alert(`Error during AI grading: ${error.message}`);
                    setLoading(false);
                    setPhase('setup');
                }
            };

            const evaluateMetricWithAgent = async (agent, metric, reportText, rubricText) => {
                try {
                    // Mock mode for testing without API
                    if (mockMode) {
                        return {
                            score: 70 + Math.random() * 20,
                            feedback: `Mock evaluation for ${metric.name} by ${agent.name}`,
                            confidence: 85,
                            reasoning: 'Mock reasoning',
                            specificStrengths: ['Mock strength 1', 'Mock strength 2'],
                            specificWeaknesses: ['Mock weakness 1'],
                            recommendations: ['Mock recommendation']
                        };
                    }
                    
                    const response = await callNetlifyFunction('ai-agent-grade', {
                        agentId: agent.id,
                        agentPrompt: agent.expertise,
                        content: reportText,
                        specificMetric: metric,
                        teacherGuidelines: rubricText,
                        apiSettings: apiSettings
                    });
                    
                    if (response.success) {
                        return response.result;
                    } else {
                        throw new Error(`Agent ${agent.name} failed: ${response.error}`);
                    }
                } catch (error) {
                    console.error(`Error with ${agent.name}:`, error);
                    throw error;
                }
            };

            const getConsensusFromAPI = async (metricEvaluations, metric, teacherGuidelines) => {
                try {
                    // Mock mode for testing without API
                    if (mockMode) {
                        const avgScore = metricEvaluations.reduce((sum, e) => sum + e.evaluation.score, 0) / metricEvaluations.length;
                        return {
                            consensusScore: avgScore,
                            reasoning: 'Mock consensus reasoning',
                            agreements: ['Mock agreement'],
                            disagreements: [],
                            confidence: 85,
                            flagsForReview: [],
                            synthesizedFeedback: 'Mock synthesized feedback',
                            keyStrengths: ['Mock strength'],
                            keyWeaknesses: ['Mock weakness'],
                            priorityRecommendations: ['Mock recommendation']
                        };
                    }
                    
                    const response = await callNetlifyFunction('consensus-moderator', {
                        metricEvaluations: metricEvaluations,
                        metric: metric,
                        teacherGuidelines: teacherGuidelines,
                        apiSettings: apiSettings
                    });
                    
                    if (response.success) {
                        return response.consensus;
                    } else {
                        throw new Error(`Consensus failed: ${response.error}`);
                    }
                } catch (error) {
                    console.error('Error getting consensus:', error);
                    throw error;
                }
            };

            const callNetlifyFunction = async (functionName, payload) => {
                try {
                    console.log(`Calling ${functionName} with:`, payload);
                    
                    // Try different URL patterns based on environment
                    const urls = [
                        `/.netlify/functions/${functionName}`,
                        `/netlify/functions/${functionName}`,
                        `${window.location.origin}/.netlify/functions/${functionName}`
                    ];
                    
                    let lastError = null;
                    
                    for (const url of urls) {
                        try {
                            console.log(`Trying URL: ${url}`);
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload)
                            });

                            const responseText = await response.text();
                            console.log(`Response from ${functionName}:`, responseText);

                            if (!response.ok) {
                                lastError = new Error(`HTTP error! status: ${response.status}, response: ${responseText}`);
                                continue;
                            }

                            try {
                                return JSON.parse(responseText);
                            } catch (e) {
                                lastError = new Error(`Invalid JSON response: ${responseText}`);
                                continue;
                            }
                        } catch (error) {
                            console.log(`Failed with URL ${url}:`, error.message);
                            lastError = error;
                            continue;
                        }
                    }
                    
                    throw lastError || new Error('All URL patterns failed');
                } catch (error) {
                    console.error(`Error calling ${functionName}:`, error);
                    throw error;
                }
            };

            const generateSpecializedDialogue = (evaluations, metric, consensusScore) => {
                const dialogue = [];
                
                // Primary agent evaluation first
                const primaryEval = evaluations.find(e => e.isPrimary);
                if (primaryEval) {
                    dialogue.push({
                        agent: primaryEval.agent.name,
                        emoji: primaryEval.agent.emoji,
                        message: `As the primary evaluator for ${metric.name}, I scored it ${primaryEval.evaluation.score}/100. ${primaryEval.evaluation.feedback}`,
                        type: 'primary-evaluation'
                    });
                }
                
                // Supporting agents
                evaluations.filter(e => !e.isPrimary).forEach(evaluation => {
                    dialogue.push({
                        agent: evaluation.agent.name,
                        emoji: evaluation.agent.emoji,
                        message: `From my perspective, I evaluated this at ${evaluation.evaluation.score}/100. ${evaluation.evaluation.feedback}`,
                        type: 'supporting-evaluation'
                    });
                });
                
                // Consensus
                dialogue.push({
                    agent: 'Consensus',
                    emoji: 'üéØ',
                    message: `Final weighted score for ${metric.name}: ${consensusScore.consensusScore}/100. ${consensusScore.reasoning}`,
                    type: 'consensus'
                });
                
                return dialogue;
            };

            const readFileAsText = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            };

            const applySupervisorAdjustments = () => {
                const adjusted = gradingResults.map(result => {
                    let adjustment = 0;
                    
                    // Apply supervisor settings
                    if (supervisorSettings.gradeDistribution === 'strict') {
                        adjustment = -Math.random() * 5; // Reduce by 0-5 points
                    } else if (supervisorSettings.gradeDistribution === 'lenient') {
                        adjustment = Math.random() * 5; // Increase by 0-5 points
                    } else {
                        adjustment = (Math.random() * 6) - 3; // -3 to +3 points
                    }
                    
                    // Industry standards check
                    if (supervisorSettings.industryStandards && result.score < 70) {
                        result.supervisorNotes = 'Below industry standards - requires significant improvement';
                    } else {
                        result.supervisorNotes = 'Adjusted for consistency and standards alignment';
                    }
                    
                    return {
                        ...result,
                        score: Math.max(0, Math.min(100, result.score + adjustment)),
                        supervisorNotes: result.supervisorNotes
                    };
                });
                
                setGradingResults(adjusted);
                setPhase('manual');
            };

            const startOver = () => {
                if (confirm('Are you sure you want to start over? Your current progress will be lost.')) {
                    setPhase('setup');
                    setEssayFile(null);
                    setRubricFile(null);
                    setGradingResults([]);
                    setProgress(0);
                    setAgentResults({});
                    setApiError('');
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-6 space-y-6">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800 mb-2">üèóÔ∏è Engineering Report Grading System</h1>
                        <p className="text-gray-600">Specialized AI evaluation for technical engineering documents</p>
                        <div className="mt-2 px-4 py-2 bg-blue-100 text-blue-800 rounded-lg inline-block">
                            <span className="text-sm font-medium">ü§ñ Powered by {apiSettings.model.toUpperCase()} with Engineering Expertise</span>
                        </div>
                    </div>

                    {/* API Error Display */}
                    {apiError && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                            <strong className="font-bold">API Error!</strong>
                            <span className="block sm:inline"> {apiError}</span>
                            <button
                                onClick={() => setMockMode(true)}
                                className="mt-2 px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                            >
                                Enable Mock Mode (Test Without API)
                            </button>
                        </div>
                    )}
                    
                    {/* Mock Mode Indicator */}
                    {mockMode && (
                        <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                            <strong className="font-bold">Mock Mode Active!</strong>
                            <span className="block sm:inline"> Running in test mode without actual API calls.</span>
                            <button
                                onClick={() => setMockMode(false)}
                                className="ml-2 text-sm underline"
                            >
                                Disable Mock Mode
                            </button>
                        </div>
                    )}

                    {/* Progress Bar */}
                    <div className="bg-white rounded-lg shadow-md p-4">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-700">Progress</span>
                            <span className="text-sm text-gray-500">{phase}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${phase === 'setup' ? 25 : phase === 'grading' ? 50 : phase === 'supervision' ? 75 : 100}%` }}
                            />
                        </div>
                        {currentProgressMessage && (
                            <p className="text-xs text-gray-600 mt-1">{currentProgressMessage}</p>
                        )}
                    </div>

                    {/* Setup Phase */}
                    {phase === 'setup' && (
                        <div className="space-y-6">
                            {/* File Upload */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-2xl font-bold mb-4">üìÅ Upload Engineering Report</h2>
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                                        <div className="text-4xl mb-3">üìÑ</div>
                                        <label className="cursor-pointer">
                                            <span className="text-lg font-medium text-gray-700">Upload Report</span>
                                            <input
                                                type="file"
                                                className="hidden"
                                                accept=".pdf,.doc,.docx,.txt"
                                                onChange={(e) => handleFileUpload(e, 'essay')}
                                            />
                                            {essayFile && (
                                                <p className="mt-2 text-sm text-green-600 flex items-center justify-center">
                                                    ‚úì {essayFile.name}
                                                </p>
                                            )}
                                        </label>
                                    </div>
                                    
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                                        <div className="text-4xl mb-3">üìã</div>
                                        <label className="cursor-pointer">
                                            <span className="text-lg font-medium text-gray-700">Course Rubric (Optional)</span>
                                            <input
                                                type="file"
                                                className="hidden"
                                                accept=".pdf,.doc,.docx,.txt"
                                                onChange={(e) => handleFileUpload(e, 'rubric')}
                                            />
                                            {rubricFile && (
                                                <p className="mt-2 text-sm text-green-600 flex items-center justify-center">
                                                    ‚úì {rubricFile.name}
                                                </p>
                                            )}
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {/* Engineering Evaluation Metrics */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-lg font-semibold">üìä Engineering Evaluation Metrics</h3>
                                    <button
                                        onClick={saveConfiguration}
                                        className="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm"
                                    >
                                        Save Configuration
                                    </button>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Total Score:</label>
                                    <input
                                        type="number"
                                        value={totalScore}
                                        onChange={(e) => setTotalScore(Number(e.target.value) || 100)}
                                        className="w-32 px-3 py-2 border rounded-lg"
                                        min="1"
                                    />
                                </div>
                                <div className="space-y-3">
                                    {metrics.map((metric, index) => (
                                        <div key={index} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div className="flex items-start gap-3">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <input
                                                            type="text"
                                                            value={metric.name}
                                                            onChange={(e) => {
                                                                const updated = [...metrics];
                                                                updated[index].name = e.target.value;
                                                                setMetrics(updated);
                                                            }}
                                                            disabled={metric.isDefault}
                                                            className={`flex-1 px-3 py-2 border rounded-lg font-medium ${metric.isDefault ? 'bg-gray-100' : ''}`}
                                                        />
                                                        <input
                                                            type="number"
                                                            value={metric.weight}
                                                            onChange={(e) => {
                                                                const updated = [...metrics];
                                                                updated[index].weight = Number(e.target.value);
                                                                setMetrics(updated);
                                                            }}
                                                            className="w-20 px-3 py-2 border rounded-lg"
                                                            min="0"
                                                            max="100"
                                                        />
                                                        <span className="text-sm text-gray-600">%</span>
                                                    </div>
                                                    <textarea
                                                        value={metric.description}
                                                        onChange={(e) => {
                                                            const updated = [...metrics];
                                                            updated[index].description = e.target.value;
                                                            setMetrics(updated);
                                                        }}
                                                        className="w-full px-3 py-2 border rounded-lg text-sm"
                                                        rows="2"
                                                        placeholder="Detailed evaluation criteria..."
                                                    />
                                                    <div className="mt-2 text-xs text-gray-600">
                                                        <span className="font-medium">Primary Evaluator:</span> {agents.find(a => a.id === metric.primaryAgent)?.name || 'Not assigned'}
                                                        {metric.supportingAgents && metric.supportingAgents.length > 0 && (
                                                            <span className="ml-2">
                                                                <span className="font-medium">Supporting:</span> {metric.supportingAgents.map(id => agents.find(a => a.id === id)?.name).join(', ')}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <div className="text-sm text-gray-600">
                                        Total Weight: {metrics.reduce((sum, m) => sum + m.weight, 0)}%
                                    </div>
                                </div>
                            </div>

                            {/* Specialized AI Agents */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-semibold mb-3">ü§ñ Specialized Engineering Evaluators</h3>
                                <div className="space-y-3">
                                    {agents.map((agent, index) => (
                                        <div key={index} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div className="flex items-start gap-3">
                                                <div className="text-3xl">{agent.emoji}</div>
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-lg mb-1">{agent.name}</h4>
                                                    <textarea
                                                        value={agent.expertise}
                                                        onChange={(e) => {
                                                            const updated = [...agents];
                                                            updated[index].expertise = e.target.value;
                                                            setAgents(updated);
                                                        }}
                                                        className="w-full px-3 py-2 border rounded-lg text-sm"
                                                        rows="4"
                                                        placeholder="Agent expertise..."
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* API Settings */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-semibold mb-3">üîß API Settings</h3>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">AI Model</label>
                                        <select
                                            value={apiSettings.model}
                                            onChange={(e) => setApiSettings({...apiSettings, model: e.target.value})}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        >
                                            <optgroup label="OpenAI Models">
                                                <option value="gpt-4o-mini">GPT-4o Mini (Fast & Cost-effective)</option>
                                                <option value="gpt-4o">GPT-4o (Balanced)</option>
                                                <option value="gpt-4-turbo">GPT-4 Turbo (128k context)</option>
                                                <option value="gpt-4">GPT-4 (8k context)</option>
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Budget option)</option>
                                            </optgroup>
                                        </select>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {apiSettings.model === 'gpt-4o-mini' && 'Recommended: Best balance of quality and cost'}
                                            {apiSettings.model === 'gpt-4o' && 'High quality with large context window'}
                                            {apiSettings.model === 'gpt-4-turbo' && 'Maximum context for very long reports'}
                                            {apiSettings.model === 'gpt-4' && 'Original GPT-4, limited context'}
                                            {apiSettings.model === 'gpt-3.5-turbo' && 'Faster but less accurate for complex analysis'}
                                        </p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Temperature</label>
                                        <input
                                            type="range"
                                            min="0"
                                            max="1"
                                            step="0.1"
                                            value={apiSettings.temperature}
                                            onChange={(e) => setApiSettings({...apiSettings, temperature: parseFloat(e.target.value)})}
                                            className="w-full"
                                        />
                                        <div className="flex justify-between text-xs text-gray-500">
                                            <span>Consistent (0)</span>
                                            <span className="font-medium">{apiSettings.temperature}</span>
                                            <span>Creative (1)</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        <strong>Token Limits:</strong>
                                        {apiSettings.model === 'gpt-4o-mini' && ' 128k context window, suitable for most reports'}
                                        {apiSettings.model === 'gpt-4o' && ' 128k context window, high quality analysis'}
                                        {apiSettings.model === 'gpt-4-turbo' && ' 128k context window, best for very long reports'}
                                        {apiSettings.model === 'gpt-4' && ' 8k context window, may need shorter reports'}
                                        {apiSettings.model === 'gpt-3.5-turbo' && ' 16k context window, basic analysis'}
                                    </p>
                                </div>
                            </div>

                            {/* Supervisor Settings */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-semibold mb-3">üë®‚Äçüè´ Instructor Supervision Settings</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Grade Distribution</label>
                                        <select
                                            value={supervisorSettings.gradeDistribution}
                                            onChange={(e) => setSupervisorSettings({...supervisorSettings, gradeDistribution: e.target.value})}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        >
                                            <option value="lenient">Lenient (Higher grades)</option>
                                            <option value="normal">Normal Distribution</option>
                                            <option value="strict">Strict (Lower grades)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={supervisorSettings.industryStandards}
                                                onChange={(e) => setSupervisorSettings({...supervisorSettings, industryStandards: e.target.checked})}
                                                className="mr-2"
                                            />
                                            <span>Apply Industry Standards (70% minimum for professional competency)</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Focus Areas</label>
                                        <div className="space-y-2">
                                            {['technical_accuracy', 'professional_standards', 'innovation', 'safety_compliance'].map(area => (
                                                <label key={area} className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={supervisorSettings.focusAreas.includes(area)}
                                                        onChange={(e) => {
                                                            const areas = e.target.checked 
                                                                ? [...supervisorSettings.focusAreas, area]
                                                                : supervisorSettings.focusAreas.filter(a => a !== area);
                                                            setSupervisorSettings({...supervisorSettings, focusAreas: areas});
                                                        }}
                                                        className="mr-2"
                                                    />
                                                    <span className="capitalize">{area.replace('_', ' ')}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Start Button */}
                            <div className="text-center">
                                <button
                                    onClick={startGrading}
                                    className="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-lg font-semibold"
                                >
                                    Start Engineering Report Evaluation
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Grading Phase */}
                    {phase === 'grading' && (
                        <div className="bg-white rounded-lg shadow-md p-8">
                            <h2 className="text-2xl font-bold mb-6 text-center">ü§ñ Specialized AI Evaluation in Progress</h2>
                            {loading ? (
                                <div className="space-y-4">
                                    <div className="text-center">
                                        <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                                            <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                        <p className="text-lg font-medium mb-2">{currentProgressMessage || 'Analyzing Engineering Report...'}</p>
                                        <p className="text-sm text-gray-600">{apiSettings.model.toUpperCase()} is evaluating technical content with engineering expertise</p>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                        <div 
                                            className="bg-blue-600 h-4 rounded-full transition-all duration-300"
                                            style={{ width: `${progress}%` }}
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                                        {agents.map((agent, index) => (
                                            <div key={index} className="text-center">
                                                <div className="text-3xl mb-2">{agent.emoji}</div>
                                                <p className="text-sm font-medium">{agent.name}</p>
                                                <p className="text-xs text-gray-600">Specialized Analysis</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center">
                                    <div className="text-6xl mb-4">‚úÖ</div>
                                    <p className="text-lg font-medium">Evaluation Complete!</p>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Supervision Phase */}
                    {phase === 'supervision' && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-2xl font-bold mb-4">üë®‚Äçüè´ Instructor Review & Quality Control</h2>
                                
                                <div className="space-y-4">
                                    {gradingResults.map((result, index) => (
                                        <div key={index} className="border rounded-lg p-4">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <h4 className="font-semibold text-lg">{result.name}</h4>
                                                    <p className="text-sm text-gray-600">{result.description}</p>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-2xl font-bold text-blue-600">
                                                        {Math.round(result.consensus)}%
                                                    </div>
                                                    <p className="text-xs text-gray-500">Weighted Score</p>
                                                </div>
                                            </div>
                                            
                                            {/* Show primary and supporting agent scores */}
                                            <div className="mt-3">
                                                <p className="text-sm font-medium mb-2">Agent Evaluations:</p>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                    {result.agentScores.map((agentScore, agentIndex) => (
                                                        <div key={agentIndex} className={`p-2 rounded text-center ${agentScore.isPrimary ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'}`}>
                                                            <p className="text-xs font-medium">{agentScore.agent}</p>
                                                            <p className="text-lg font-bold">{agentScore.score}%</p>
                                                            {agentScore.isPrimary && <p className="text-xs text-blue-600">Primary</p>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Consensus reasoning */}
                                            <div className="mt-3 p-3 bg-gray-50 rounded">
                                                <p className="text-sm font-medium">Consensus Reasoning:</p>
                                                <p className="text-sm text-gray-700">{result.consensusReasoning}</p>
                                            </div>
                                            
                                            {/* Show dialogue if expanded */}
                                            <details className="mt-3">
                                                <summary className="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                                                    View Agent Discussion ({result.dialogue?.length || 0} messages)
                                                </summary>
                                                <div className="mt-2 space-y-2 max-h-60 overflow-y-auto">
                                                    {result.dialogue?.map((msg, msgIndex) => (
                                                        <div key={msgIndex} className={`p-2 rounded-lg text-sm ${
                                                            msg.type === 'consensus' ? 'bg-green-100' : 
                                                            msg.type === 'primary-evaluation' ? 'bg-blue-50' : 
                                                            'bg-gray-100'
                                                        }`}>
                                                            <div className="flex items-start gap-2">
                                                                <span className="text-lg">{msg.emoji}</span>
                                                                <div className="flex-1">
                                                                    <span className="font-medium">{msg.agent}:</span>
                                                                    <span className="ml-2">{msg.message}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </details>
                                            
                                            {/* Flags for review */}
                                            {result.flagsForReview?.length > 0 && (
                                                <div className="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                                    <p className="text-sm font-medium text-yellow-800">üö© Requires Review:</p>
                                                    <ul className="text-sm text-yellow-700 mt-1">
                                                        {result.flagsForReview.map((flag, flagIndex) => (
                                                            <li key={flagIndex}>‚Ä¢ {flag}</li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="mt-6 flex gap-4 justify-center">
                                    <button
                                        onClick={applySupervisorAdjustments}
                                        className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                                    >
                                        Apply Instructor Adjustments
                                    </button>
                                    <button
                                        onClick={() => {
                                            setPhase('grading');
                                            performSpecializedGrading();
                                        }}
                                        className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                    >
                                        Re-evaluate Report
                                    </button>
                                    <button
                                        onClick={startOver}
                                        className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    >
                                        Start Over
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Manual Adjustment Phase */}
                    {phase === 'manual' && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-2xl font-bold mb-4">‚úèÔ∏è Final Review & Manual Adjustments</h2>
                                
                                {/* Engineering Standards Check */}
                                <div className="bg-blue-50 p-4 rounded-lg mb-6">
                                    <h3 className="font-semibold mb-2">Engineering Standards Compliance</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        {gradingResults.map((result, index) => (
                                            <div key={index} className="flex justify-between">
                                                <span className="text-sm">{result.name}:</span>
                                                <span className={`font-medium ${result.score >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {Math.round(result.score)}% {result.score < 70 && '‚ö†Ô∏è'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-2 pt-2 border-t">
                                        <div className="flex justify-between font-semibold">
                                            <span>Overall Score:</span>
                                            <span className={`${Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0)) >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                                                {Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0))}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    {gradingResults.map((result, index) => (
                                        <div key={index} className="border rounded-lg p-4">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold">{result.name}</h4>
                                                    <p className="text-sm text-gray-600">{result.description}</p>
                                                    <p className="text-sm text-blue-600 mt-1">AI Score: {Math.round(result.score)}%</p>
                                                </div>
                                                <div className="text-center">
                                                    <label className="text-xs text-gray-500">Manual Override</label>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        value={result.score}
                                                        onChange={(e) => {
                                                            const updated = [...gradingResults];
                                                            updated[index].score = Number(e.target.value);
                                                            setGradingResults(updated);
                                                        }}
                                                        className="w-32"
                                                    />
                                                    <div className="text-2xl font-bold text-blue-600">
                                                        {Math.round(result.score)}%
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Supervisor notes */}
                                            {result.supervisorNotes && (
                                                <div className="bg-yellow-50 p-3 rounded mb-3">
                                                    <p className="text-sm font-medium">Supervisor Note:</p>
                                                    <p className="text-sm text-gray-700">{result.supervisorNotes}</p>
                                                </div>
                                            )}
                                            
                                            {/* Instructor feedback */}
                                            <div>
                                                <label className="text-sm font-medium">Instructor Feedback:</label>
                                                <textarea
                                                    className="w-full px-3 py-2 border rounded-lg text-sm mt-1"
                                                    rows="3"
                                                    placeholder="Add specific feedback for this criterion..."
                                                    value={result.manualFeedback || ''}
                                                    onChange={(e) => {
                                                        const updated = [...gradingResults];
                                                        updated[index].manualFeedback = e.target.value;
                                                        setGradingResults(updated);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="mt-6 flex gap-4 justify-center">
                                    <button
                                        onClick={() => setPhase('final')}
                                        className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                                    >
                                        Finalize Grading
                                    </button>
                                    <button
                                        onClick={saveResults}
                                        className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                    >
                                        Save Results
                                    </button>
                                    <button
                                        onClick={startOver}
                                        className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    >
                                        Start Over
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Final Results */}
                    {phase === 'final' && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-2xl font-bold mb-6 text-center">üìä Final Engineering Report Assessment</h2>
                                
                                <div className="text-center p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                                    <h3 className="text-2xl font-bold mb-2">Final Grade</h3>
                                    <div className="text-5xl font-bold text-blue-600 mb-2">
                                        {Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0) * (totalScore / 100))} / {totalScore}
                                    </div>
                                    <div className="text-lg text-gray-600">
                                        {Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0))}%
                                    </div>
                                    {Math.round(gradingResults.reduce((sum, r) => sum + (r.score / 100) * r.weight, 0)) >= 70 ? (
                                        <p className="text-green-600 font-medium mt-2">‚úÖ Meets Industry Standards</p>
                                    ) : (
                                        <p className="text-red-600 font-medium mt-2">‚ö†Ô∏è Below Industry Standards</p>
                                    )}
                                </div>
                                
                                <div className="mt-6 space-y-4">
                                    {gradingResults.map((result, index) => (
                                        <div key={index} className="bg-gray-50 rounded-lg p-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="font-semibold text-lg">{result.name}</h4>
                                                <div className="text-2xl font-bold text-blue-600">
                                                    {Math.round((result.score / 100) * result.weight * (totalScore / 100))} / {Math.round(result.weight * (totalScore / 100))}
                                                </div>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                                <div 
                                                    className="bg-blue-600 h-3 rounded-full"
                                                    style={{ width: `${result.score}%` }}
                                                />
                                            </div>
                                            
                                            {/* Primary evaluator feedback */}
                                            <p className="text-sm text-gray-700 mb-1">
                                                <span className="font-medium">Primary Assessment:</span> {result.feedback}
                                            </p>
                                            
                                            {/* Supervisor adjustments */}
                                            {result.supervisorNotes && (
                                                <p className="text-sm text-orange-600 italic">
                                                    Supervisor: {result.supervisorNotes}
                                                </p>
                                            )}
                                            
                                            {/* Manual feedback */}
                                            {result.manualFeedback && (
                                                <p className="text-sm text-purple-600 italic">
                                                    Instructor: {result.manualFeedback}
                                                </p>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Overall Recommendations */}
                                <div className="mt-6 bg-blue-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-2">Engineering Competency Summary</h3>
                                    <ul className="space-y-1 text-sm">
                                        {gradingResults.map((result, index) => (
                                            <li key={index}>
                                                ‚Ä¢ <span className="font-medium">{result.name}:</span> 
                                                {result.score >= 85 ? ' Excellent proficiency demonstrated' :
                                                 result.score >= 70 ? ' Meets professional standards' :
                                                 result.score >= 60 ? ' Developing competency, needs improvement' :
                                                 ' Significant gaps requiring remediation'}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                
                                <div className="mt-6 flex gap-4 justify-center">
                                    <button
                                        onClick={saveResults}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        Download Full Report
                                    </button>
                                    <button
                                        onClick={startOver}
                                        className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    >
                                        Grade Another Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EssayGradingSystem />);
    </script>
</body>
</html>